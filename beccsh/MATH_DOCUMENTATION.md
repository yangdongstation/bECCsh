# bECCsh 数学文档

## 椭圆曲线密码学基础

### 1. 椭圆曲线定义

在有限域 GF(p) 上，椭圆曲线由以下方程定义：
```
y² ≡ x³ + ax + b (mod p)
```

其中：
- p 是一个大素数（曲线素数）
- a, b 是曲线系数，满足 4a³ + 27b² ≠ 0 (mod p)
- (x, y) 是曲线上的点坐标

### 2. 支持的椭圆曲线

#### 2.1 secp256r1 (P-256)
- **素数 p**: 2²²⁴(2³²-1)+2¹⁹²+2⁹⁶-1
- **系数 a**: -3 (mod p)
- **系数 b**: 41058363725152142129326129780047268409114441015993725554835256314039467401291
- **基点 G**: (48439561293906451759052585252797914202762949526041747995844080717082404635286, 36134250956749795798585127919587881956611106672985015071877198253596914405152)
- **阶 n**: 115792089210356248762697446949407573529996955224135760342422259061068512044369
- **余因子 h**: 1

#### 2.2 secp256k1 (Bitcoin曲线)
- **素数 p**: 2²⁵⁶ - 2³² - 977
- **系数 a**: 0
- **系数 b**: 7
- **基点 G**: (55066263022277343669578718895168534326250603453777594175500187360389116729240, 32670510020758816978083085130507043184471273380659243275938904335757337482424)
- **阶 n**: 115792089237316195423570985008687907852837564279074904382605163141518161494337
- **余因子 h**: 1

#### 2.3 secp384r1 (P-384)
- **素数 p**: 2³⁸⁴ - 2¹²⁸ - 2⁹⁶ + 2³² - 1
- **系数 a**: -3 (mod p)
- **系数 b**: 2758019355995970607849028223445720178978875123960259293929437120438843699239729028775223912950546402317996436254009
- **基点 G**: (26247035095799689268623156744566981891852923491109213387815615900925518854738050089346156210313581438655224340864196, 8325710961489029985546751289520108179287853048861315597642602047990433924380039231073394954859324759218459144373943)
- **阶 n**: 3940200619639447921227904010014361380507973927046544666794690527962765939911326356939895630814249494415240690691151
- **余因子 h**: 1

### 3. 椭圆曲线点运算

#### 3.1 点加法
对于两个不同的点 P = (x₁, y₁) 和 Q = (x₂, y₂)：
```
λ = (y₂ - y₁) / (x₂ - x₁) mod p
x₃ = λ² - x₁ - x₂ mod p
y₃ = λ(x₁ - x₃) - y₁ mod p
```

#### 3.2 点加倍
对于点 P = (x₁, y₁)：
```
λ = (3x₁² + a) / (2y₁) mod p
x₃ = λ² - 2x₁ mod p
y₃ = λ(x₁ - x₃) - y₁ mod p
```

#### 3.3 标量乘法
对于整数 k 和点 P：
```
kP = P + P + ... + P (k次)
```

使用二进制方法计算：
```
result = ∞
for i from 255 downto 0:
    result = 2 * result
    if k的第i位为1:
        result = result + P
```

### 4. ECDSA算法

#### 4.1 密钥生成
1. 选择随机数 d ∈ [1, n-1] 作为私钥
2. 计算 Q = dG 作为公钥
3. 公钥 Q = (x, y) 可以公开

#### 4.2 签名生成
输入：消息哈希 h，私钥 d
输出：签名 (r, s)

1. 选择随机数 k ∈ [1, n-1]
2. 计算点 (x₁, y₁) = kG
3. 计算 r = x₁ mod n，如果 r = 0，重新选择 k
4. 计算 k⁻¹ mod n
5. 计算 s = k⁻¹(h + rd) mod n，如果 s = 0，重新选择 k
6. 签名结果为 (r, s)

#### 4.3 签名验证
输入：消息哈希 h，签名 (r, s)，公钥 Q
输出：验证成功或失败

1. 检查 r, s ∈ [1, n-1]
2. 计算 w = s⁻¹ mod n
3. 计算 u₁ = hw mod n
4. 计算 u₂ = rw mod n
5. 计算点 (x₁, y₁) = u₁G + u₂Q
6. 验证 r ≡ x₁ mod n

### 5. 数学正确性证明

#### 5.1 签名验证的正确性
如果签名是有效的，那么：
```
s = k⁻¹(h + rd) mod n
ks = h + rd mod n
h = ks - rd mod n
```

验证时：
```
u₁G + u₂Q = (hw)G + (rw)Q
           = (hw)G + (rw)(dG)
           = (hw + rwd)G
           = w(h + rd)G
           = w(ks)G
           = kG
```

因此 x₁ = x坐标(kG) = r，验证通过。

### 6. 安全性考虑

#### 6.1 密钥长度
- secp256r1: 256位密钥，128位安全级别
- secp256k1: 256位密钥，128位安全级别
- secp384r1: 384位密钥，192位安全级别

#### 6.2 随机数k的重要性
- 每个签名必须使用不同的随机数k
- 如果k被重用，可以通过两个签名计算出私钥
- 如果k可预测，可以恢复私钥

#### 6.3 侧信道攻击
- 时序攻击：通过测量计算时间推断密钥信息
- 功耗分析：通过分析功耗模式推断密钥
- 故障攻击：通过引入计算错误推断密钥

### 7. 实现细节

#### 7.1 大数运算
使用bc命令进行大数运算：
- 模加法: (a + b) % p
- 模减法: (a - b) % p
- 模乘法: (a * b) % p
- 模逆元: 使用扩展欧几里得算法

#### 7.2 熵收集
多源熵收集确保密钥生成的随机性：
- 键盘输入时序
- CPU执行时序抖动
- 系统状态信息
- 网络状态信息
- 硬件信息
- 进程信息

#### 7.3 优化技术
- 窗口方法：预计算减少点乘次数
- Karatsuba乘法：加速大数乘法
- 预计算表：缓存常用点乘结果

### 8. 测试向量

#### 8.1 secp256r1测试
使用标准测试向量验证实现的正确性。

#### 8.2 边界条件测试
- 零点的处理
- 无穷远点的处理
- 大数的边界条件
- 模运算的正确性

### 9. 参考文献

1. SEC 2: Recommended Elliptic Curve Domain Parameters
   http://www.secg.org/sec2-v2.pdf

2. FIPS PUB 186-4: Digital Signature Standard (DSS)
   http://nvlpubs.nist.gov/nistpubs/FIPS/NIST.FIPS.186-4.pdf

3. RFC 6979: Deterministic Usage of DSA and ECDSA
   https://tools.ietf.org/html/rfc6979

4. Guide to Elliptic Curve Cryptography
   Hankerson, Menezes, Vanstone

---

*本文档描述了bECCsh中实现的椭圆曲线密码学数学基础。虽然实现具有讽刺性质，但数学原理是严谨的。*